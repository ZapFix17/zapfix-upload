<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZapFix - Watch</title>
<style>
  body { font-family:'Poppins',sans-serif; background:#E0F3FF; margin:0; color:#333; }
  header { display:flex; align-items:center; justify-content:space-between; background:#fff; padding:15px 25px; box-shadow:0 2px 8px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10; }
  .logo { font-size:26px; font-weight:700; color:#0077ff; cursor:pointer; }
  .nav-right { display:flex; gap:12px; align-items:center; }
  .search-bar { display:flex; align-items:center; background:#f2f4f8; padding:6px 10px; border-radius:8px; gap:8px; }
  .search-bar input { border:none; background:transparent; outline:none; font-size:14px; width:160px; }
  main { display:grid; grid-template-columns:2fr 1fr; gap:25px; padding:30px; }
  .video-section { background:white; border-radius:16px; padding:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
  video { width:100%; border-radius:12px; background:#000; max-height:480px; }
  .video-title { font-size:20px; font-weight:600; margin-top:10px; }
  .video-actions { margin-top:12px; display:flex; gap:12px; align-items:center; }
  button.like { background:#0077ff; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  .comment-section { margin-top:20px; background:#E7F3FF; padding:15px; border-radius:12px; }
  .comments-list .comment { background:white; padding:8px; border-radius:8px; margin-top:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
  .next-section { background:white; padding:15px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); max-height:70vh; overflow:auto; }
</style>
</head>
<body>
<header>
  <div class="logo" onclick="location.href='feed.html'">ZAPFIX</div>
  <div class="nav-right">
    <div class="search-bar"><i>üîç</i><input id="searchInput" placeholder="Search videos..."></div>
    <button onclick="location.href='upload.html'">Upload Video</button>
  </div>
</header>

<main>
  <section class="video-section">
    <video id="player" controls></video>
    <div class="video-title" id="title">Loading...</div>

    <div class="video-actions">
      <button id="likeBtn" class="like">üëç <span id="likesCount">0</span></button>
      <button id="shareBtn">Share</button>
    </div>

    <div class="comment-section">
      <h3>Comments</h3>
      <input id="commentName" placeholder="Your name" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">
      <textarea id="commentText" rows="3" placeholder="Add a comment..." style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #ccc;"></textarea>
      <div style="text-align:right;margin-top:8px;">
        <button id="postCommentBtn" class="like">Post</button>
      </div>
      <div class="comments-list" id="commentsList"></div>
    </div>
  </section>

  <aside class="next-section">
    <h4>Next Video Suggestions</h4>
    <div id="nextVideos"></div>
  </aside>
</main>

<script>
const BACKEND_URL = "https://zapfix-backend-f8km.onrender.com"; // update if different

function qs(name) {
  const url = new URL(location.href);
  return url.searchParams.get(name);
}

const videoId = qs("id");

// Elements
const player = document.getElementById("player");
const titleEl = document.getElementById("title");
const likesCount = document.getElementById("likesCount");
const likeBtn = document.getElementById("likeBtn");
const postCommentBtn = document.getElementById("postCommentBtn");
const commentName = document.getElementById("commentName");
const commentText = document.getElementById("commentText");
const commentsList = document.getElementById("commentsList");
const nextVideosEl = document.getElementById("nextVideos");
const searchInput = document.getElementById("searchInput");

let currentVideo = null;
let allVideos = [];

async function loadAllVideos() {
  try {
    const res = await fetch(BACKEND_URL + "/videos");
    const data = await res.json();
    if (data.success && Array.isArray(data.videos)) {
      allVideos = data.videos;
    }
  } catch (err) { console.error(err); }
}

async function loadVideo(id) {
  try {
    const res = await fetch(BACKEND_URL + "/videos/" + id);
    const data = await res.json();
    if (data.success && data.video) {
      currentVideo = data.video;
      player.src = currentVideo.video;
      titleEl.textContent = currentVideo.title;
      likesCount.textContent = currentVideo.likes || 0;
      renderComments(currentVideo.comments || []);
    } else {
      titleEl.textContent = "Video not found";
    }
  } catch (err) {
    console.error(err);
    titleEl.textContent = "Failed to load video";
  }
}

function renderComments(comments) {
  commentsList.innerHTML = "";
  (comments || []).forEach(c => {
    const d = document.createElement("div");
    d.className = "comment";
    d.innerHTML = `<strong>${escapeHtml(c.name)}</strong><p>${escapeHtml(c.text)}</p>`;
    commentsList.appendChild(d);
  });
}

function escapeHtml(s) {
  if (!s) return "";
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
}

likeBtn.addEventListener("click", async () => {
  if (!currentVideo) return;
  try {
    const res = await fetch(BACKEND_URL + "/videos/" + currentVideo._id + "/like", { method: "POST" });
    const data = await res.json();
    if (data.success) likesCount.textContent = data.likes;
  } catch (err) { console.error(err); }
});

postCommentBtn.addEventListener("click", async () => {
  const name = commentName.value.trim();
  const text = commentText.value.trim();
  if (!name || !text) return alert("Enter name and comment");
  try {
    const res = await fetch(BACKEND_URL + "/videos/" + currentVideo._id + "/comments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, text })
    });
    const data = await res.json();
    if (data.success) {
      renderComments(data.comments);
      commentName.value = ""; commentText.value = "";
    } else {
      alert("Failed to post comment");
    }
  } catch (err) { console.error(err); alert("Failed to post comment"); }
});

function renderNextVideos() {
  nextVideosEl.innerHTML = "";
  const suggestions = allVideos.filter(v => v._id !== (currentVideo && currentVideo._id)).slice(0, 10);
  suggestions.forEach(v => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.gap = "10px";
    div.style.marginTop = "8px";
    div.innerHTML = `<img src="${v.thumbnail}" style="width:120px;height:70px;object-fit:cover;border-radius:6px"><div><strong>${escapeHtml(v.title)}</strong><p style="margin:6px 0 0;font-size:13px">${escapeHtml(v.description||'')}</p></div>`;
    div.style.cursor = "pointer";
    div.addEventListener("click", () => location.href = "watch.html?id=" + v._id);
    nextVideosEl.appendChild(div);
  });
}

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  const children = Array.from(nextVideosEl.children);
  children.forEach(c => {
    const text = c.textContent.toLowerCase();
    c.style.display = text.includes(q) ? "" : "none";
  });
});

(async function init(){
  await loadAllVideos();
  if (videoId) {
    await loadVideo(videoId);
  } else if (allVideos.length) {
    // default to first video
    location.href = "watch.html?id=" + allVideos[0]._id;
    return;
  }
  renderNextVideos();
})();
</script>
</body>
</html>

